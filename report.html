<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GN-Fit Í≤∞Í≥º Î≥¥Í≥†ÏÑú</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #89a230;
            /* Olive Green */
            --text-main: #343a40;
            --text-sub: #868e96;
            --bg-gray: #F8F9FA;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --radius: 20px;
        }

        body {
            background-color: var(--bg-gray);
            font-family: 'Noto Sans KR', sans-serif;
            color: var(--text-main);
            margin: 0;
            padding: 40px 0;
            display: flex;
            justify-content: center;
        }

        /* A4 Layout */
        .page-container {
            width: 794px;
            /* A4 Width */
            min-height: 1123px;
            /* A4 Height */
            background: white;
            padding: 50px 60px;
            box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            margin-bottom: 40px;
            /* Space between pages on screen */
            display: flex;
            flex-direction: column;
        }

        /* Page Break for PDF */
        .page-break {
            page-break-before: always;
            margin-top: 50px;
            border-top: 2px dashed #dee2e6;
            /* Visual separation on screen */
            padding-top: 50px;
        }

        @media print {
            body {
                background: none;
                padding: 0;
            }

            .page-container {
                width: 100%;
                height: 100%;
                box-shadow: none;
                margin: 0;
                padding: 40px;
                margin-bottom: 0;
            }

            .no-print {
                display: none !important;
            }

            .page-break {
                margin-top: 0;
                border: none;
                padding-top: 0;
            }
        }

        /* Header */
        .slim-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 40px;
        }

        .header-left .h-name {
            font-size: 36px;
            font-weight: 900;
            color: #2c3e50;
        }

        .header-left .h-name span {
            font-size: 20px;
            font-weight: 500;
            color: #adb5bd;
            margin-left: 8px;
        }

        .header-left .h-meta {
            font-size: 13px;
            color: #adb5bd;
            margin-top: 5px;
        }

        .header-right {
            text-align: right;
        }

        .h-score {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
        }

        .h-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            vertical-align: middle;
            margin-left: 10px;
        }

        /* Section Title */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
            padding-left: 15px;
        }

        /* Visual Section (Page 1) */
        .visual-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 40px;
            align-items: start;
            margin-bottom: 30px;
        }

        /* Silhouette */
        .silhouette-box {
            position: relative;
            width: 220px;
            height: 350px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .liquid-container {
            width: 100%;
            height: 100%;
            position: absolute;
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 200'%3E%3Cpath d='M50,0 C30,0 20,20 20,30 C20,40 10,50 10,80 C10,120 25,120 25,150 L25,200 L45,200 L45,160 L55,160 L55,200 L75,200 L75,150 C75,120 90,120 90,80 C90,50 80,40 80,30 C80,20 70,0 50,0 Z'/%3E%3C/svg%3E");
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 200'%3E%3Cpath d='M50,0 C30,0 20,20 20,30 C20,40 10,50 10,80 C10,120 25,120 25,150 L25,200 L45,200 L45,160 L55,160 L55,200 L75,200 L75,150 C75,120 90,120 90,80 C90,50 80,40 80,30 C80,20 70,0 50,0 Z'/%3E%3C/svg%3E");
            -webkit-mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-position: center;
            background: #f1f3f5;
        }

        .liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: var(--primary);
            transition: height 1.5s ease-out;
            opacity: 0.9;
        }

        .wave {
            position: absolute;
            top: -10px;
            left: 0;
            width: 200%;
            height: 20px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z' fill='%23ffffff' fill-opacity='0.4'/%3E%3C/svg%3E");
            background-size: 50% 100%;
            animation: wave 3s linear infinite;
        }

        @keyframes wave {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        /* Card UI */
        .info-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid #f1f3f5;
            margin-bottom: 20px;
        }

        .desc-text {
            font-size: 14px;
            color: #495057;
            line-height: 1.6;
        }

        /* Page 2: Bar Charts */
        .bar-chart-row {
            margin-bottom: 30px;
        }

        .bar-label {
            font-size: 14px;
            font-weight: 700;
            color: #343a40;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .bar-bg {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: 6px;
            transition: width 1s;
        }

        footer {
            margin-top: auto;
            border-top: 1px solid #eee;
            padding-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #ced4da;
        }
    </style>
</head>

<body>

    <!-- Main Container (Will be PDF-ed) -->
    <div id="report-content">

        <!-- PAGE 1 -->
        <div class="page-container">
            <header class="slim-header">
                <div class="header-left" style="display: flex; flex-direction: column; align-items: flex-start;">
                    <img src="gn_logo.jpg" style="height: 35px; margin-bottom: 10px;">
                    <div style="display:flex; align-items:baseline;">
                        <span id="u-name" class="h-name">---</span> <span
                            style="font-size:20px; font-weight:500; color:#adb5bd; margin-left:8px;">Îãò</span>
                    </div>
                    <div class="h-meta" id="u-meta">Loading...</div>
                </div>
                <div class="header-right">
                    <div class="h-score">Ï¢ÖÌï© <span id="u-total">0</span>Ï†ê</div>
                    <div id="u-badge" class="h-badge">Ïã†Î¢∞ÎèÑ -</div>
                </div>
            </header>

            <div class="section-title">üìå Ï¢ÖÌï© Ïó≠Îüâ Î∂ÑÏÑù (6ÎåÄ ÌïµÏã¨ Ï≤ôÎèÑ)</div>
            <div class="visual-grid">
                <div>
                    <!-- Silhouette -->
                    <div class="silhouette-box">
                        <div class="liquid-container">
                            <div class="liquid" id="liquid-fill">
                                <div class="wave"></div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:20px; font-weight:700; color:#495057;">
                        Ï†ÑÏ≤¥ Ï†ÅÌï©ÎèÑ ÏãúÍ∞ÅÌôî
                    </div>
                </div>
                <div>
                    <!-- Radar Chart -->
                    <div style="height: 300px; width: 100%;">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h3 style="margin:0 0 10px 0; font-size:16px;">üí° Ï¢ÖÌï© ÌèâÍ∞Ä</h3>
                <p class="desc-text" id="main-desc">Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...</p>
            </div>

            <footer>GN-Fit Ïù∏ÏÑ±Í≤ÄÏÇ¨ Í≤∞Í≥ºÎ≥¥Í≥†ÏÑú (Page 1/2)</footer>
        </div>

        <!-- PAGE 2 -->
        <div class="page-container page-break">
            <header class="slim-header">
                <div class="header-left" style="display:flex; align-items:center; gap:15px;">
                    <img src="gn_logo.jpg" style="height: 30px;">
                    <div class="h-name" style="font-size:24px;">ÏÉÅÏÑ∏ Ïó≠Îüâ Î∞è ÏÉÅÌô© ÌåêÎã® Î∂ÑÏÑù</div>
                </div>
            </header>

            <div class="section-title">‚öñÔ∏è ÏÉÅÌô©ÌåêÎã®(SJT) Ïó≠Îüâ ÏÉÅÏÑ∏</div>
            <div class="info-card">
                <!-- SJT Bar Charts -->
                <div class="bar-chart-row">
                    <div class="bar-label"><span>ÏúÑÍ∏∞Í¥ÄÎ¶¨ Îä•Î†•</span> <span id="sjt-1-score">0Ï†ê</span></div>
                    <div class="bar-bg">
                        <div class="bar-fill" id="sjt-1-bar"></div>
                    </div>
                </div>
                <div class="bar-chart-row">
                    <div class="bar-label"><span>ÌòëÏóÖ Î∞è Í∞àÎì±Ï°∞Ï†ï</span> <span id="sjt-2-score">0Ï†ê</span></div>
                    <div class="bar-bg">
                        <div class="bar-fill" id="sjt-2-bar"></div>
                    </div>
                </div>
                <div class="bar-chart-row">
                    <div class="bar-label"><span>ÏßÅÏóÖÏú§Î¶¨ Î∞è Í∑úÏ†ïÏ§ÄÏàò</span> <span id="sjt-3-score">0Ï†ê</span></div>
                    <div class="bar-bg">
                        <div class="bar-fill" id="sjt-3-bar"></div>
                    </div>
                </div>
                <div class="bar-chart-row">
                    <div class="bar-label"><span>ÏÑ±Í≥ºÏßÄÌñ• Î∞è Ïã§ÌñâÎ†•</span> <span id="sjt-4-score">0Ï†ê</span></div>
                    <div class="bar-bg">
                        <div class="bar-fill" id="sjt-4-bar"></div>
                    </div>
                </div>
            </div>

            <div class="section-title">üîç ÏùëÎãµ Ïã†Î¢∞ÎèÑ Î∂ÑÏÑù</div>
            <div class="info-card" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:14px; color:#888;">ÏùºÍ¥ÄÏÑ± ÏßÄÏàò (Consistency)</div>
                    <div style="font-size:24px; font-weight:800; color:#343a40;" id="rel-score">- / 20</div>
                </div>
                <div style="text-align:right;">
                    <div id="rel-result" style="font-size:18px; font-weight:bold; color:var(--primary);">ÌåêÏ†ï: -</div>
                    <div style="font-size:12px; color:#aaa; margin-top:5px;">* Ïú†ÏÇ¨ Î¨∏Ìï≠ Í∞Ñ ÏùëÎãµ ÏùºÏπòÎèÑÎ•º Î∂ÑÏÑùÌï®</div>
                </div>
            </div>

            <footer>GN-Fit Ïù∏ÏÑ±Í≤ÄÏÇ¨ Í≤∞Í≥ºÎ≥¥Í≥†ÏÑú (Page 2/2)</footer>
        </div>

    </div>

    <!-- Download Trigger -->
    <div class="no-print" style="position:fixed; bottom:30px; right:30px;">
        <button onclick="downloadPDF()"
            style="background:#2c3e50; color:white; padding:15px 30px; border:none; border-radius:50px; font-weight:bold; cursor:pointer; box-shadow:0 5px 15px rgba(0,0,0,0.2);">
            PDF Îã§Ïö¥Î°úÎìú
        </button>
    </div>

    <script>
        const DATA_URL = "https://script.google.com/macros/s/AKfycbxWJqjwMgbsySFDu2toUnDaoqZb5AVLdtMB0FUjoO1lLpliA3KuoZfGEdUtlUPR4QnI/exec";

        // --- SCORING CONFIG ---
        // 6 Categories (Base 1-60 + SJT 81-100)
        // Format: [ [NormalQs...], [SJTQs...] ]
        const CAT_MAP = {
            "Ï£ºÎèÑÏÑ±": [[1, 10], [81, 88]],      // 1~10 + 81,88
            "Î¨∏Ï†úÌï¥Í≤∞": [[11, 20], [82, 87, 91, 98]],
            "ÌòëÏóÖÎä•Î†•": [[21, 30], [84, 93]],
            "ÏÑ±Ïã§ÏÑ±": [[31, 40], [83, 90, 95, 97]],
            "Ï†ÅÏùëÎ†•": [[41, 50], [86, 96, 100]],
            "ÏùòÏÇ¨ÏÜåÌÜµ": [[51, 60], [85, 89, 94, 99]]
        };

        // Reliability Pairs (Q1 vs Q61 ...)
        const MIRROR_PAIRS = [];
        for (let i = 1; i <= 20; i++) MIRROR_PAIRS.push([i, 60 + i]);

        function getVal(obj, keys) {
            for (let k of keys) if (obj[k] !== undefined && obj[k] !== "") return obj[k];
            return "-";
        }

        // --- CORE SCORING ENGINE ---
        function calculateStats(user) {
            const stats = {};
            let totalSum = 0;
            let maxTotal = 0;

            // 1. Calculate 6 Capabilities
            for (const [catName, ranges] of Object.entries(CAT_MAP)) {
                let score = 0;
                let maxScore = 0;

                // Normal Qs (Range e.g., 1-10)
                const [start, end] = ranges[0];
                for (let i = start; i <= end; i++) {
                    const ans = user['Q' + i];
                    if (ans === 'A') score += 10;
                    else if (ans === 'B') score += 5;
                    maxScore += 10;
                }

                // SJT Qs (Array)
                const sjtIds = ranges[1];
                for (let i of sjtIds) {
                    const b = parseInt(user[`Q${i}_Best`] || 0);
                    const w = parseInt(user[`Q${i}_Worst`] || 0);

                    // Logic: Best(1)=+5, Worst(2)=+5, Best(3)=-5, Worst(4)=-5
                    if (b === 1) score += 5;
                    if (b === 3) score -= 5;
                    if (w === 2) score += 5;
                    if (w === 4) score -= 5;

                    maxScore += 10; // Approx max potential per SJT item
                }

                // Normalize to 100
                const percent = Math.max(0, Math.round((score / maxScore) * 100)); // Clamp 0~100
                stats[catName] = percent;
                totalSum += percent;
            }

            stats.totalVar = Math.round(totalSum / 6);

            // 2. Reliability
            let matchCount = 0;
            for (let pair of MIRROR_PAIRS) {
                const a1 = user['Q' + pair[0]];
                const a2 = user['Q' + pair[1]];
                if (a1 && a2 && a1 === a2) matchCount++;
            }
            stats.reliability = matchCount;

            // 3. SJT Sub-Factors (Page 2)
            // Mapping defined in request or inferred from CAT structure logic for visualization
            // "Crisis": (Problem Solving + Adaptability subset) -> Let's map specifically for visual chart
            // We'll calculate average of relevant SJT items for these labels
            // Simple mapping for display purposes primarily using the CAT scores as proxies or recalculating
            stats.sjtValues = {
                "ÏúÑÍ∏∞Í¥ÄÎ¶¨": stats["Î¨∏Ï†úÌï¥Í≤∞"], // Proxy based on content
                "ÌòëÏóÖÏ°∞Ï†ï": stats["ÌòëÏóÖÎä•Î†•"],
                "ÏßÅÏóÖÏú§Î¶¨": stats["ÏÑ±Ïã§ÏÑ±"],
                "ÏÑ±Í≥ºÏßÄÌñ•": stats["Ï£ºÎèÑÏÑ±"]
            };

            return stats;
        }

        async function init(name, phone) {
            try {
                const res = await fetch(DATA_URL);
                const data = await res.json();

                const user = data.find(u => {
                    const n = getVal(u, ['ÏÑ±Î™Ö', 'Ïù¥Î¶Ñ', 'name']);
                    const p = getVal(u, ['Ìú¥ÎåÄÌè∞Î≤àÌò∏', 'Ïó∞ÎùΩÏ≤ò', 'phone']);
                    return n === name || (n === name && p === phone);
                });

                if (user) renderReport(user);
                else alert("Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå");
            } catch (e) { console.error(e); }
        }

        // --- RENDER LOGIC ---
        function renderReport(user) {
            const stats = calculateStats(user);

            // Text Data
            const name = getVal(user, ['ÏÑ±Î™Ö', 'Ïù¥Î¶Ñ', 'name']);
            const birth = getVal(user, ['ÏÉùÎÖÑÏõîÏùº', 'birth']);
            const ts = getVal(user, ['ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ', 'ÏùëÏãúÏùºÏãú', 'time']);
            const dateStr = ts !== '-' ? ts.split('T')[0] : '-';

            document.getElementById('u-name').innerText = name;
            document.getElementById('u-meta').innerText = `ÏÉùÎÖÑÏõîÏùº: ${birth} | ÏùëÏãúÏùºÏãú: ${dateStr}`;
            document.getElementById('u-total').innerText = stats.totalVar;

            // Liquid Anim
            setTimeout(() => {
                document.getElementById('liquid-fill').style.height = stats.totalVar + '%';
            }, 500);

            // Reliability
            const rScore = stats.reliability;
            let rLabel = "Low (Ïû¨Í≤ÄÏÇ¨)";
            let rColor = "#fa5252"; // Red
            if (rScore >= 18) { rLabel = "High (Îß§Ïö∞ ÎÜíÏùå)"; rColor = "#89a230"; } // Green
            else if (rScore >= 14) { rLabel = "Mid (Î≥¥ÌÜµ)"; rColor = "#fab005"; } // Yellow

            document.getElementById('u-badge').innerText = `Ïã†Î¢∞ÎèÑ ${rLabel}`;
            document.getElementById('u-badge').style.background = rColor;

            // Page 2 Consistency
            document.getElementById('rel-score').innerText = `${rScore} / 20`;
            document.getElementById('rel-result').innerText = `ÌåêÏ†ï: ${rLabel}`;
            document.getElementById('rel-result').style.color = rColor;

            // Main Desc
            let txt = "";
            if (stats.totalVar >= 80) txt = "Ï°∞ÏßÅÏùò ÌïµÏã¨ Í∏∞Îë•Ïù¥ Îê† Îõ∞Ïñ¥ÎÇú Ïù∏Ïû¨ÏûÖÎãàÎã§. Ï†Ñ ÏòÅÏó≠ÏóêÏÑú Í≥†Î•∏ Ïó≠ÎüâÏùÑ Î≥¥Ïó¨Ï§çÎãàÎã§.";
            else if (stats.totalVar >= 60) txt = "Ï†ÑÎ∞òÏ†ÅÏúºÎ°ú ÏñëÌò∏Ìïú Ïó≠ÎüâÏùÑ Î≥¥Ïú†ÌïòÍ≥† ÏûàÏúºÎ©∞, ÏßÅÎ¨¥ Ï†ÅÏùëÏóê Î¨¥Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.";
            else txt = "ÏùºÎ∂Ä Ïó≠Îüâ Í∞úÎ∞úÏù¥ ÌïÑÏöîÌïòÎ©∞, Î©¥Ï†ë Ïãú Ïã¨Ï∏µÏ†ÅÏù∏ Í≤ÄÏ¶ùÏù¥ Í∂åÏû•Îê©ÎãàÎã§.";
            document.getElementById('main-desc').innerText = txt;

            // Chart: Radar
            new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: {
                    labels: ['Ï£ºÎèÑÏÑ±', 'Î¨∏Ï†úÌï¥Í≤∞', 'ÌòëÏóÖÎä•Î†•', 'ÏÑ±Ïã§ÏÑ±', 'Ï†ÅÏùëÎ†•', 'ÏùòÏÇ¨ÏÜåÌÜµ'],
                    datasets: [{
                        label: 'Ïó≠Îüâ Ï†êÏàò',
                        data: [stats['Ï£ºÎèÑÏÑ±'], stats['Î¨∏Ï†úÌï¥Í≤∞'], stats['ÌòëÏóÖÎä•Î†•'], stats['ÏÑ±Ïã§ÏÑ±'], stats['Ï†ÅÏùëÎ†•'], stats['ÏùòÏÇ¨ÏÜåÌÜµ']],
                        backgroundColor: 'rgba(137, 162, 48, 0.2)',
                        borderColor: '#89a230',
                        pointBackgroundColor: '#89a230',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 100, ticks: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });

            // Page 2: SJT Bars
            const sjt = stats.sjtValues;
            fillBar('sjt-1', sjt['ÏúÑÍ∏∞Í¥ÄÎ¶¨']);
            fillBar('sjt-2', sjt['ÌòëÏóÖÏ°∞Ï†ï']);
            fillBar('sjt-3', sjt['ÏßÅÏóÖÏú§Î¶¨']);
            fillBar('sjt-4', sjt['ÏÑ±Í≥ºÏßÄÌñ•']);
        }

        function fillBar(id, val) {
            document.getElementById(id + '-score').innerText = val + "Ï†ê";
            setTimeout(() => {
                document.getElementById(id + '-bar').style.width = val + '%';
            }, 500);
        }

        // Public for Admin
        window.loadForPrint = function (user) {
            renderReport(user);
        }

        function downloadPDF() {
            const el = document.getElementById('report-content');
            const n = document.getElementById('u-name').innerText;
            // Get birth for filename
            const meta = document.getElementById('u-meta').innerText; // has birth
            let birth = "000000";
            // Simple parse assumes format
            try { birth = meta.match(/ÏÉùÎÖÑÏõîÏùº: (\d+)/)[1]; } catch (e) { }

            const opt = {
                margin: 0,
                filename: `${n}_${birth}_GNFit_Î≥¥Í≥†ÏÑú.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(el).save();
        }

        // Auto-run if params
        document.addEventListener('DOMContentLoaded', () => {
            const p = new URLSearchParams(window.location.search);
            if (p.get('name')) init(p.get('name'), p.get('phone'));
        });

    </script>
</body>

</html>