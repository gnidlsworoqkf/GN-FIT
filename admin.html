<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GN-Fit ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #89a230;
            --secondary: #2c3e50;
            --bg-body: #F8F9FA;
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
            --radius-main: 24px;
            --radius-sm: 12px;
            --text-main: #343a40;
            --text-sub: #868e96;
            --color-mint: #E2ECE9;
            --color-yellow: #FFF9DB;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            color: var(--secondary);
            letter-spacing: -0.5px;
        }

        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(137, 162, 48, 0.3);
            transition: transform 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        .dash-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 40px;
        }

        .dash-card {
            background: white;
            padding: 30px;
            border-radius: var(--radius-main);
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dash-icon {
            width: 60px;
            height: 60px;
            border-radius: 20px;
            background: var(--bg-body);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }

        .dash-info h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: var(--text-sub);
            font-weight: 500;
        }

        .dash-info .value {
            margin: 0;
            font-size: 28px;
            font-weight: 800;
            color: var(--secondary);
        }

        .table-panel {
            background: white;
            border-radius: var(--radius-main);
            box-shadow: var(--card-shadow);
            padding: 30px;
            position: relative;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--secondary);
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            opacity: 0.5;
            pointer-events: none;
            transition: 0.3s;
        }

        .bulk-actions.active {
            opacity: 1;
            pointer-events: all;
        }

        .btn-bulk {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-black {
            background: var(--secondary);
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            color: var(--text-sub);
            font-size: 13px;
            font-weight: 600;
            padding: 15px 10px;
            border-bottom: 2px solid #f1f3f5;
        }

        td {
            padding: 15px 10px;
            border-bottom: 1px solid #f8f9fa;
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .score-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 700;
            background: var(--color-mint);
            color: #0b7285;
        }

        .btn-view {
            background: #fff;
            border: 1px solid #dee2e6;
            padding: 6px 12px;
            border-radius: 8px;
            color: #495057;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-view:hover {
            background: #f8f9fa;
        }

        #pdf-factory {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 794px;
            background: white;
            z-index: -1;
        }

        #progress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .progress-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            width: 300px;
        }

        .p-bar-bg {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .p-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>

<body>
    <header>
        <h1>GN-Fit Admin</h1>
        <button class="refresh-btn" onclick="fetchData()">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
    </header>

    <div class="dash-grid">
        <div class="dash-card">
            <div class="dash-icon" style="color: #4dabf7; background: #e7f5ff;">ğŸ‘¥</div>
            <div class="dash-info">
                <h3>ì´ ì§€ì›ì</h3>
                <div class="value" id="total-count">-</div>
            </div>
        </div>
        <div class="dash-card">
            <div class="dash-icon" style="color: #69db7c; background: #ebfbee;">ğŸ“…</div>
            <div class="dash-info">
                <h3>ì˜¤ëŠ˜ ì‘ì‹œ</h3>
                <div class="value" id="today-count">-</div>
            </div>
        </div>
        <div class="dash-card">
            <div class="dash-icon" style="color: #ffd43b; background: #fff9db;">ğŸ†</div>
            <div class="dash-info">
                <h3>í‰ê·  ì ìˆ˜</h3>
                <div class="value" id="avg-score">-</div>
            </div>
        </div>
    </div>

    <div class="table-panel">
        <div class="panel-header">
            <div class="panel-title">ì§€ì›ì ë¦¬ìŠ¤íŠ¸</div>
            <div class="bulk-actions" id="bulk-actions">
                <button class="btn-bulk btn-black" onclick="downloadSelectedPDFs()">
                    ğŸ“„ ì„ íƒ í•­ëª© PDF ì¼ê´„ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th width="50"><input type="checkbox" id="check-all" onclick="toggleAll(this)"></th>
                    <th>ì´ë¦„</th>
                    <th>ì—°ë½ì²˜</th>
                    <th>ì‘ì‹œ ì¼ì‹œ</th>
                    <th>ì ìˆ˜</th>
                    <th>ìƒíƒœ</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr>
                    <td colspan="7" style="text-align:center; padding: 30px; color:#aaa;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <iframe id="pdf-frame" style="position:fixed; top:-10000px; width:794px; height:1123px; border:none;"></iframe>

    <div id="progress-modal">
        <div class="progress-box">
            <h3 style="margin:0; color:#333;">PDF ìƒì„± ì¤‘...</h3>
            <p id="progress-text" style="color:#888; font-size:13px; margin-top:5px;">0 / 0</p>
            <div class="p-bar-bg">
                <div class="p-bar-fill" id="p-fill"></div>
            </div>
            <button onclick="cancelBulk()"
                style="background:#eee; border:none; padding:8px 20px; border-radius:5px; cursor:pointer;">ì¤‘ë‹¨</button>
        </div>
    </div>

    <script>
        const DATA_URL = "https://script.google.com/macros/s/AKfycbw4K1Jyx5FedXDf5yAmSsFL3eEg_1qwHgRAJNx9YKxlZ3DE5sKnzudc9fENzZBp4UVL/exec";
        let allData = [];
        let isCanceling = false;

        document.addEventListener('DOMContentLoaded', () => {
            const frame = document.getElementById('pdf-frame');
            frame.src = "report.html";
            fetchData();
        });

        // Helper for Key Fallback
        function getVal(obj, keys) {
            for (let k of keys) {
                if (obj[k] !== undefined && obj[k] !== "") return obj[k];
            }
            return "-";
        }

        async function fetchData() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">ë¡œë”© ì¤‘...</td></tr>';

            try {
                const res = await fetch(DATA_URL);
                const json = await res.json();
                allData = json.reverse();

                // DEBUG LOG for User/Dev
                if (allData.length > 0) console.log("First Row Keys:", Object.keys(allData[0]));

                updateDashboard(allData);
                renderTable(allData);
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>';
            }
        }

        function updateDashboard(data) {
            document.getElementById('total-count').innerText = data.length;

            const now = new Date();
            let realToday = 0;
            data.forEach(d => {
                const ts = getVal(d, ['timestamp', 'time', 'ì¼ì‹œ']);
                if (ts !== '-') {
                    const dDate = new Date(ts);
                    if (dDate.getDate() === now.getDate() && dDate.getMonth() === now.getMonth()) realToday++;
                }
            });
            document.getElementById('today-count').innerText = realToday;

            let totalScoreSum = 0;
            data.forEach(d => totalScoreSum += getScore(d));
            const avg = data.length ? Math.round(totalScoreSum / data.length) : 0;
            document.getElementById('avg-score').innerText = avg + "ì ";
        }

        function getScore(user) {
            let p1 = 0;
            for (let i = 1; i <= 80; i++) if (user['Q' + i] === 'A') p1 += 1.25;
            let p2 = 0;
            for (let i = 81; i <= 100; i++) {
                const b = user['Q' + i + '_Best'] || user['Q' + i + '_Best '];
                const w = user['Q' + i + '_Worst'] || user['Q' + i + '_Worst '];
                if (parseInt(b) == 1 && parseInt(w) == 2) p2 += 5;
            }
            return Math.round((p1 + p2) / 2);
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach((row, idx) => {
                const tr = document.createElement('tr');
                const score = getScore(row);

                // Robust Data Fetch
                const name = getVal(row, ['name', 'ì´ë¦„', 'ì„±ëª…', 'ì§€ì›ì']);
                const phone = getVal(row, ['phone', 'contact', 'ì—°ë½ì²˜', 'íœ´ëŒ€í°', 'ì „í™”ë²ˆí˜¸']);
                const ts = getVal(row, ['timestamp', 'time', 'ì¼ì‹œ', 'ì‘ì‹œì¼ì‹œ']);
                const tsDisplay = ts !== '-' ? ts.split('T')[0] : '-';

                tr.innerHTML = `
                    <td><input type="checkbox" class="row-check" value="${idx}" onclick="checkBulkState()"></td>
                    <td><b>${name}</b></td>
                    <td style="color:#868e96">${phone}</td>
                    <td>${tsDisplay}</td>
                    <td><span class="score-pill">${score}ì </span></td>
                    <td><span style="font-size:12px; color:#adb5bd;">ì™„ë£Œ</span></td>
                    <td>
                        <button class="btn-view" onclick="openReport('${name}', '${phone}')">ë³´ê¸°</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleAll(source) {
            document.querySelectorAll('.row-check').forEach(c => c.checked = source.checked);
            checkBulkState();
        }

        function checkBulkState() {
            const checked = document.querySelectorAll('.row-check:checked');
            const bulkDiv = document.getElementById('bulk-actions');
            if (checked.length > 0) bulkDiv.classList.add('active');
            else bulkDiv.classList.remove('active');
        }

        function openReport(name, phone) {
            window.location.href = `report.html?name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}`;
        }

        async function downloadSelectedPDFs() {
            const checked = document.querySelectorAll('.row-check:checked');
            if (checked.length === 0) return;
            if (!confirm(`${checked.length}ëª…ì˜ ë³´ê³ ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.`)) return;

            const modal = document.getElementById('progress-modal');
            const pText = document.getElementById('progress-text');
            const pFill = document.getElementById('p-fill');
            modal.style.display = 'flex';
            isCanceling = false;

            const frameWin = document.getElementById('pdf-frame').contentWindow;

            if (!frameWin.loadForPrint) {
                alert("í…œí”Œë¦¿ ë¡œë”© ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                modal.style.display = 'none';
                return;
            }

            for (let i = 0; i < checked.length; i++) {
                if (isCanceling) break;

                const idx = checked[i].value;
                const user = allData[idx];
                const cleanName = getVal(user, ['name', 'ì´ë¦„', 'ì„±ëª…']);

                pText.innerText = `${i + 1} / ${checked.length} (${cleanName})`;
                pFill.style.width = `${((i + 1) / checked.length) * 100}%`;

                frameWin.loadForPrint(user); // Inject Data
                await new Promise(r => setTimeout(r, 800)); // Wait for Anim

                const element = frameWin.document.getElementById('report-content');
                const birth = getVal(user, ['birth', 'ìƒë…„ì›”ì¼']);

                const opt = {
                    margin: 0,
                    filename: `${cleanName}_${birth}_ë¶„ì„ë³´ê³ ì„œ.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                await html2pdf().set(opt).from(element).save();
                await new Promise(r => setTimeout(r, 500));
            }

            modal.style.display = 'none';
            if (!isCanceling) alert("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function cancelBulk() {
            isCanceling = true;
            document.getElementById('progress-modal').style.display = 'none';
        }
    </script>
</body>

</html>